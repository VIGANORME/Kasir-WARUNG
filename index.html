<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kasir Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    :root{
        --bg:#e9f2ff;
        --card:#fff;
        --primary:#0a64d4;
        --border:#d0dffc;
        --input-border:#b3ccff;
        --item-border:#cfe0ff;
        --text:#000;
    }
    body {font-family:Arial;margin:0;background:var(--bg);color:var(--text);}
    header {
        background:var(--primary);
        color:#fff;
        padding:14px;
        font-size:18px;
        font-weight:700;
        text-align:center;
        position:relative;
    }

    /* TOMBOL BULAN DI TENGAH ATAS */
    .moon-btn{
        position:absolute;
        top:-1px;
        left:50%;
        transform:translateX(-50%);
        background:none;
        border:none;
        font-size:28px;
        color:white;
        cursor:pointer;
    }

    .wrap {padding:14px;}
    .card {background:var(--card);padding:14px;border-radius:10px;margin-bottom:14px;border:1px solid var(--border);}
    button {width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;margin-top:6px;cursor:pointer}
    .small-btn{width:auto;padding:8px 10px;font-size:14px;border-radius:8px;margin-left:6px}
    input {width:100%;padding:12px;border-radius:10px;border:1px solid var(--input-border);margin-bottom:12px;box-sizing:border-box}
    .item {padding:10px;border:1px solid var(--item-border);border-radius:10px;margin-bottom:8px;background:var(--card);display:flex;justify-content:space-between;align-items:center;box-sizing:border-box}
    .item .left{flex:1;cursor:pointer}
    .meta{font-size:13px;color:#555}
    .row{display:flex;gap:8px}
    .muted{color:#666;font-size:13px}

    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{width:92%;max-width:420px;background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border)}
    .flex-between{display:flex;justify-content:space-between;align-items:center}

    /* DARK MODE */
    .dark{
        --bg:#0b0b0b;
        --card:#0e0e10;
        --primary:#0a64d4;
        --border:#1a2938;
        --input-border:#1f2f43;
        --item-border:#14202b;
        --text:#e6eefc;
    }

</style>
</head>

<body>

<header>
    Kasir Warung Kopi
    <button id="moon" class="moon-btn">ðŸŒ™</button>
</header>

<div class="wrap" id="page"></div>

<div id="modalRoot" style="display:none"></div>

<script>
// FORMAT RUPIAH
function rp(x){
    x = Number(x) || 0
    const s = Math.floor(x).toString()
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".")
}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function load(k,d){return JSON.parse(localStorage.getItem(k)||JSON.stringify(d))}

let products = load("products", [])
let cart = load("cart", [])
let transactions = load("transactions", [])
let isDark = load("kasir_dark_mode", false)

document.documentElement.classList.toggle("dark", !!isDark)

// ================== RENDER KASIR ==================
function renderKasir(){
    page.innerHTML = `
        <div class="card">
            <button onclick="renderAddMenu()">+ Tambah Menu</button>
        </div>

        <div class="card">
            <h3>Pilih Produk</h3>
            ${products.length === 0 ? `<div class="item"><div class="left">Belum ada menu</div></div>` :
            products.map((p,i)=>`
                <div class="item" onclick="addToCart(${i})">
                    <div class="left">${p.name}</div>
                    <div class="meta">Rp ${rp(p.price)}</div>
                </div>
            `).join("")}
        </div>

        <div class="card">
            <h3>Keranjang</h3>
            ${renderCart()}
            <h3>Total: Rp <span id="liveTotal">${rp(calcTotal())}</span></h3>
            <input id="buyer" placeholder="Nama Pemesan">
            <button onclick="checkout()">Checkout</button>
        </div>

        <div class="card">
            <h3>Laporan</h3>
            <b>Hari ini:</b> <span id="harian">Rp 0</span><br><br>
            <b>Bulan ini:</b> <span id="bulanan">Rp 0</span>
        </div>

        <div class="card">
            <div class="flex-between">
                <h3>Transaksi</h3>
                <button class="small-btn" onclick="exportCSV()">Export CSV</button>
            </div>
            <div id="txList">
                ${
                    transactions.length===0
                    ? `<div class="muted">Belum ada transaksi</div>`
                    : transactions.map(t=>`
                        <div class="item">
                            <div class="left">${t.time} â€” ${t.name}</div>
                            <div class="meta">Rp ${rp(t.total)}</div>
                        </div>
                    `).join("")
                }
            </div>
        </div>
    `;
    updateIncome();
}

// ================== TAMBAH MENU ==================
function renderAddMenu(){
    page.innerHTML = `
        <div class="card">
            <h3>Tambah Menu Baru</h3>
            <input id="nm" placeholder="Nama Menu">
            <input id="hg" type="number" placeholder="Harga">
            <div class="row">
                <button onclick="saveMenu()">Simpan Menu</button>
                <button class="small-btn" onclick="renderKasir()">Kembali</button>
            </div>
        </div>

        <div class="card">
            <h3>Daftar Menu</h3>
            ${
                products.length===0
                ? `<div class="muted">Belum ada menu</div>`
                : products.map((p,i)=>`
                    <div class="item">
                        <div style="flex:1">
                            <div style="font-weight:700">${p.name}</div>
                            <div class="meta">Rp ${rp(p.price)}</div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px">
                            <button class="small-btn" onclick="event.stopPropagation();openEdit(${i})">Edit</button>
                            <button class="small-btn" onclick="event.stopPropagation();deleteMenu(${i})">Hapus</button>
                        </div>
                    </div>
                `).join("")
            }
        </div>
    `;
}

function saveMenu(){
    let n=document.getElementById("nm").value.trim()
    let h=Number(document.getElementById("hg").value)
    if(!n||!h) return alert("Isi nama dan harga")
    products.push({name:n, price:h})
    save("products",products)
    renderAddMenu()
}

function deleteMenu(i){
    if(!confirm("Hapus menu?")) return
    products.splice(i,1)
    save("products",products)
    renderAddMenu()
}

function openEdit(i){
    const p=products[i]
    modalRoot.innerHTML=`
        <div class="modal-bg">
            <div class="modal">
                <div class="flex-between">
                    <strong>Edit Menu</strong>
                    <button class="small-btn" onclick="closeModal()">X</button>
                </div>
                <input id="editName" value="${p.name}">
                <input id="editPrice" type="number" value="${p.price}">
                <div class="row">
                    <button onclick="saveEdit(${i})">Simpan</button>
                    <button class="small-btn" onclick="closeModal()">Batal</button>
                </div>
            </div>
        </div>
    `
    modalRoot.style.display="block"
}
function closeModal(){modalRoot.style.display="none";modalRoot.innerHTML=""}

function saveEdit(i){
    let n=document.getElementById("editName").value.trim()
    let h=Number(document.getElementById("editPrice").value)
    if(!n||!h) return alert("Isi dengan benar")
    products[i]={name:n,price:h}
    save("products",products)
    closeModal()
    renderAddMenu()
}

// ================== KERANJANG ==================
function addToCart(i){
    const p=products[i]
    const f=cart.find(c=>c.name===p.name)
    if(f) f.qty++
    else cart.push({name:p.name,price:p.price,qty:1})
    save("cart",cart)
    renderKasir()
}

function renderCart(){
    if(cart.length===0) return `<div class='muted'>Keranjang kosong</div>`
    return cart.map((c,i)=>`
        <div class="item">
            <div style="flex:1">
                <div style="font-weight:700">${c.name} (x${c.qty})</div>
                <div class="meta">Rp ${rp(c.price*c.qty)}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px">
                <button class="small-btn" onclick="decQty(${i})">-</button>
                <button class="small-btn" onclick="incQty(${i})">+</button>
            </div>
        </div>
    `).join("")
}

function incQty(i){cart[i].qty++;save("cart",cart);renderKasir()}
function decQty(i){
    cart[i].qty--;
    if(cart[i].qty<=0) cart.splice(i,1)
    save("cart",cart)
    renderKasir()
}

function calcTotal(){return cart.reduce((a,b)=>a+(b.price*b.qty),0)}

// ================== CHECKOUT ==================
function checkout(){
    if(cart.length===0) return alert("Keranjang kosong")
    let name=document.getElementById("buyer").value.trim()
    if(!name) return alert("Isi nama pemesan")

    const total=calcTotal()
    const time=new Date().toLocaleString("id-ID")
    transactions.push({name,total,time})
    save("transactions",transactions)

    cart=[]
    save("cart",cart)
    renderKasir()
}

// ================== LAPORAN ==================
function updateIncome(){
    const today=new Date().toLocaleDateString("id-ID")
    const now=new Date()
    let m=now.getMonth()+1
    let y=now.getFullYear()

    const harian=transactions.filter(t=>t.time.startsWith(today)).reduce((s,i)=>s+i.total,0)
    const bulanan=transactions.filter(t=>{
        const d=new Date(t.time)
        return d.getMonth()+1===m && d.getFullYear()===y
    }).reduce((s,i)=>s+i.total,0)

    if(harian) document.getElementById("harian").textContent="Rp "+rp(harian)
    if(bulanan) document.getElementById("bulanan").textContent="Rp "+rp(bulanan)
}

// ================== EXPORT ==================
function exportCSV(){
    if(transactions.length===0) return alert("Tidak ada data")
    let rows=[["Waktu","Nama Pemesan","Total (Rp)"]]
    transactions.forEach(t=>rows.push([`"${t.time}"`,`"${t.name.replace(/"/g,'""')}"`,t.total]))
    let csv=rows.map(r=>r.join(",")).join("\n")
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"})
    const url=URL.createObjectURL(blob)
    let a=document.createElement("a")
    a.href=url;a.download="transaksi.csv";a.click()
    URL.revokeObjectURL(url)
}

// ================== DARK MODE TOGGLE (MOON ICON) ==================
document.getElementById("moon").addEventListener("click",()=>{
    isDark=!isDark
    document.documentElement.classList.toggle("dark",isDark)
    save("kasir_dark_mode",isDark)
})

// START
renderKasir()
</script>

</body>
</html>